<!DOCTYPE html>
<html>
<head>
    <title>Breathing Exercises</title>

    <!-- jsPsych -->
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.0.0"></script>

    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" />
</head>

<body></body>

<script>


// initialise jsPsych
const jsPsych = initJsPsych({
    override_safe_mode: true,
});

const timeline = [];


// welcome message
const welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<h3><b>Welcome to the 4-7-8 breathing exercise</b></h3> <p>Press any key to begin</p>",
    choices: [" "]
};

timeline.push(welcome)

/* fullscreen on */
const fullscreen_on = {
    type: jsPsychFullscreen,
    fullscreen_mode: true,
    message: "<p>Press the button to enter fullscreen</p>",
    button_label: "Continue"
};

timeline.push(fullscreen_on)


// instructions
const instructions = {
    type: jsPsychHtmlButtonResponse,
    choices: ["Start the demonstration"],

    stimulus:`
    <h2><b>4-7-8 Breathing Exercise Instructions</b></h2>
        <p>Based on ancient mindful breathing practices, the "4-7-8" breathing exercise is a popular technique used to slow down the activity of the nervous system. This technique consists of the following:</p>
          <ul>1.) <b>INHALE</b> for 4 seconds <b>through your nostrils</b></ul>
          <ul>2.) <b>HOLD</b> your breath for 7 seconds</ul>
          <ul>3.) <b>EXHALE</b> for 8 seconds <b>through your mouth</b></ul>
        <p>This exercise is usually practiced over 4 consecutive repetitions (cycles).
        <h3>In this experiment, here is what each cycle will look like:</h3>
        <figure>
          <img src="478_representation.png", alt="one cycle of 4-7-8", width = 900
        </figure>
        <br>
        <p>When you are ready, press the button to view a demonstration of <b>one cycle</b> of this breathing technique. You do <b>not</b> need to perform the exercise at this time.</p>
    `
}

timeline.push(instructions)


// ---- trial loop ----
// fixation + countdown (3s)
const fixation_with_countdown = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style = "font-size:500%;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">+</div>

    <div id="countdown" style="
      font-size: 50px;
      position: fixed;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">
      3
    </div>
  `,
  choices: "NO_KEYS",
  trial_duration: 3000,

  on_start: function () {
    document.body.style.backgroundColor = "white"
    document.body.style.cursor = "none"

    let count = 3
    let countdownInterval = setInterval(() => {
      count--
      if (count > 0) {
        const el = document.getElementById("countdown")
        if (el) el.innerText = count
      } else {
        clearInterval(countdownInterval)
      }
    }, 1000)
  },

  on_finish: function () {
    document.body.style.backgroundColor = "white"
  }
}

// inhale + countdown (4s)
const inhale_with_countdown = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style = "font-size:300%;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">
      <b>Inhale (nose)</b>
    </div>

    <div id="countdown" style="
      font-size: 50px;
      position: fixed;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">
      4
    </div>
  `,
  choices: "NO_KEYS",
  trial_duration: 4000,

  on_start: function () {
    document.body.style.backgroundColor = "white"
    document.body.style.cursor = "none"

    let count = 4
    let countdownInterval = setInterval(() => {
      count--
      if (count > 0) {
        const el = document.getElementById("countdown")
        if (el) el.innerText = count
      } else {
        clearInterval(countdownInterval)
      }
    }, 1000)
  },

  on_finish: function () {
    document.body.style.backgroundColor = "white"
  }
}

// hold + countdown (7s)
const hold_with_countdown = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style = "font-size:300%;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">
      <b>Hold</b>
    </div>

    <div id="countdown" style="
      font-size: 50px;
      position: fixed;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">
      7
    </div>
  `,
  choices: "NO_KEYS",
  trial_duration: 7000,

  on_start: function () {
    document.body.style.backgroundColor = "white"
    document.body.style.cursor = "none"

    let count = 7
    let countdownInterval = setInterval(() => {
      count--
      if (count > 0) {
        const el = document.getElementById("countdown")
        if (el) el.innerText = count
      } else {
        clearInterval(countdownInterval)
      }
    }, 1000)
  },

  on_finish: function () {
    document.body.style.backgroundColor = "white"
  }
}

// exhale + countdown (8s)
const exhale_with_countdown = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style = "font-size:300%;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">
      <b>Exhale (mouth)</b>
    </div>

    <div id="countdown" style="
      font-size: 50px;
      position: fixed;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    ">
      8
    </div>
  `,
  choices: "NO_KEYS",
  trial_duration: 8000,

  on_start: function () {
    document.body.style.backgroundColor = "white"
    document.body.style.cursor = "none"

    let count = 8
    let countdownInterval = setInterval(() => {
      count--
      if (count > 0) {
        const el = document.getElementById("countdown")
        if (el) el.innerText = count
      } else {
        clearInterval(countdownInterval)
      }
    }, 1000)
  },

  on_finish: function () {
    document.body.style.backgroundColor = "white"
  }
}

// practice trial loop sequence (1 repetition)
const practice = {
    timeline: [fixation_with_countdown, inhale_with_countdown, hold_with_countdown, exhale_with_countdown],
    repetitions: 1,
}

//timeline.push(practice)


// screen before experimental trials

const instructions_2 = {
    type: jsPsychHtmlButtonResponse,
    choices: ["Start the breathing exercise"],

    stimulus:`
    <h2><b>Before We Start</b></h2>
        <p>To ensure you benefit from this exercise, you <b>must</b> do the following:</p>
          <ul>Sit upright </ul>
        <p>In the experiment, you will see a 3-2-1 countdown before the first 4-7-8 cycle.</p>
        <p>This countdown will <b>not</b> be included in the subsequent cycles: once one cycle has finished, 
          the next cycle will immediately follow until four cycles have been completed.</p>
        <br>
        <p>Press the button when you are ready to start the breathing exercise</p>
    `
}

timeline.push(instructions_2)


// fixation before trial loop sequence
timeline.push(fixation_with_countdown)


// experiment trial loop sequence (4 repetitions)
const procedure = {
    timeline: [inhale_with_countdown, hold_with_countdown, exhale_with_countdown],
    repetitions: 4,
}

timeline.push(procedure)


// end of task
const finish = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<h3><b>You have now finished the 4-7-8 breathing exercise.</b></h3>",
    choices: [" "]
};

timeline.push(finish)


// run the experiment
jsPsych.run(timeline);

</script>

</html>